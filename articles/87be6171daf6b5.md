---
title: "Dockerã§Goè£½ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ãªã‚‰distrolessã‚’ä½¿ãŠã†ã¨ã„ã†ãŠè©±"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go", "Docker"]
published: true
---

# ã¯ã˜ã‚ã«

ã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚Œã§ã™ãŒï¼Œè¦ã¯ distroless ã¨ Go è£½ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç›¸æ€§ãŒã„ã„ã£ã¦ã„ã†ã ã‘ã®ãŠè©±ã§ã™ï¼

# distroless ã¨ã¯

distroless ã¯ï¼ŒGoogle ãŒé–‹ç™ºã—ã¦ã„ã‚‹ Debian ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§æœ€å°é™ã®ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹å«ã¾ã‚Œã¦ã„ãªã„[^1]ãŸã‚ã¨ã¦ã‚‚è»½é‡ã¨ã„ã†ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼

https://github.com/GoogleContainerTools/distroless

**æœ€å°é™ã®ãƒ•ã‚¡ã‚¤ãƒ«ã—ã‹å«ã¾ã‚Œã¦ã„ãªã„**ã¨ã„ã†ã®ã¯ä¼Šé”ã§ãªãã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚‚ã‚ˆã‚Šã¾ã™ãŒ`glibc`ãƒ»`libssl`ãƒ»`openssl`ã™ã‚‰å«ã¾ã‚Œã¦ã„ãªã„ã§ã™ï¼
ã‚·ã‚§ãƒ«ã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚‚å«ã¾ã‚Œã¦ã„ãªã„ãŸã‚ï¼Œå¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã—ãªã„ã¨ã„ã‘ãªã„ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯å‘ãã¾ã›ã‚“ãŒã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã§å‹•ä½œã™ã‚‹ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯å‘ã„ã¦ã„ã¾ã™ï¼
ã¾ãŸï¼Œæœ€å°é™ã®ãƒ•ã‚©ã‚¤ãƒ«ã—ã‹å«ã¾ã‚Œã¦ã„ãªã„ãŸã‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚‚å°ã•ããªã‚Šã¾ã™ï¼ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå°ã•ããªã£ã¦ä¸éƒ½åˆãŒèµ·ã“ã‚‹ã“ã¨ã¯åŸºæœ¬çš„ã«ã¯ç„¡ã„ã¨æ€ã„ã¾ã™ï¼ãã†ã„ã£ãŸæ„å‘³ã§ã‚‚ï¼Œdistroless ã‚’æ¡ç”¨ã™ã‚‹ã®ã¯ã‚ã‚Šã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ï¼

# distroless Ã— Go

Go è£½ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã§å‹•ä½œã™ã‚‹ãŸã‚`glibc`ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ä¾å­˜ã—ã¾ã›ã‚“ï¼ãã®ãŸã‚ distroless ã§ã‚‚å•é¡Œãªãå‹•ä½œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼\
ãã®ãŸã‚ distroless ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒã‚¤ãƒŠãƒªã§å‹•ä½œã™ã‚‹ Go ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ï¼Œã¨ã¦ã‚‚ç›¸æ€§ãŒè‰¯ã„ã§ã™ï¼

# distroless vs Alphine

è»½é‡ãªãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨è¨€ã†ã¨ Alphine ã‚‚æœ‰ã‚‹ã¨æ€ã„ã¾ã™ï¼ã§ã™ãŒï¼Œæœ€è¿‘ã¯ Alphine ã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã‚ˆã‚Šã‚‚ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã®ã»ã†ãŒå¤§ãããªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™[^2]ï¼\
ã¾ãŸï¼Œdistroless ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¯ Alphine ã® 50%ç¨‹åº¦ã‚‰ã—ã„ã®ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è»½é‡åŒ–ã ã‘ãŒç›®çš„ãªã‚‰ distroless ã‚’ä½¿ã£ãŸã»ã†ãŒè‰¯ã„ã§ã—ã‚‡ã†ï¼

> **å‚è€ƒ**
> Distroless images are very small. The smallest distroless image, gcr.io/distroless/static-debian11, is around 2 MiB. That's about 50% of the size of alpine (~5 MiB), and less than 2% of the size of debian (124 MiB).

# distroless ã‚’ä½¿ã†ã¨ãã®æ³¨æ„

ã¾ãšã‚·ã‚§ãƒ«ãŒå«ã¾ã‚Œã¦ã„ãªã„ãŸã‚å®Ÿè¡Œãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼

```Dockerfile
ENTRYPOINT ["myapp"]
```

ã¾ãŸï¼Œã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚·ã‚§ãƒ«ã‹ã‚‰èµ·å‹•ã™ã‚‹ã®ã‚’é˜²ããŸã‚ã« exec å½¢å¼ã§æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™[^3]ï¼
exec å½¢å¼ã¯ï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«`ENTRYPOINT []`ã®ã‚«ãƒƒã‚³å†…ã«èµ·å‹•ã—ãŸã„å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’æ›¸ãæ–¹å¼ã§ã™ï¼Docker ã‚‚ï¼Œã“ã®æ›¸ãæ–¹ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™[^4]ï¼

```Dockerfile
# Bad : ENTRYPOINT "myapp"

# Good
ENTRYPOINT ["myapp"]
```

ã¾ãŸï¼Œdistroless ã‚’ä½¿ç”¨ã™ã‚‹éš›ã¯ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’æ´»ç”¨ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼\
Docker ã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼

```Dockerfile
#=============== Build ===============
FROM golang:1.20 as build

WORKDIR /app
COPY . .
RUN go mod download
RUN CGO_ENABLED=0 go build -o /app/bin

#============ Application ============
FROM gcr.io/distroless/static-debian11

COPY --from=build /app/bin /
CMD ["/app"]
```

# ã¾ã¨ã‚

Docker ã§ Go è£½ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ã¨ãã«ã¯ distroless ã‚‚è€ƒãˆã¦ã¿ã‚‹ã¨ã„ã„ã‚ˆã£ã¦ã„ã†è©±ã§ã—ãŸï¼\
ã‚‚ã¡ã‚ã‚“ï¼Œdistroless ã§ã¯ãªã debian-slim ãªã©ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã»ã†ãŒé©åˆ‡ãªå ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒé¸æŠè‚¢ã®ä¸€ã¤ã¨ã—ã¦ distroless ã‚’ãŠã™ã™ã‚ã§ããŸãªã‚‰ã¨æ€ã„ã¾ã™ï¼

# ãŠã¾ã‘

`glibc`ã‚’å«ã‚“ã§ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚æœ‰ã‚‹ãŸã‚ Rust ãªã©ã§ä½œæˆã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼ã¾ãŸï¼Œä¸€éƒ¨ã®è¨€èªã«é–¢ã—ã¦ã¯å®Ÿè¡Œç’°å¢ƒãŒå«ã‚ã‚‰ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚æœ‰ã‚‹ã®ã§å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã‚’è¦—ã„ã¦ã¿ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ï¼

[^1]: https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md#image-contents
[^2]: https://blog.inductor.me/entry/alpine-not-recommended
[^3]: https://github.com/GoogleContainerTools/distroless/blob/main/README.md#entrypoints
[^4]: https://docs.docker.jp/v1.12/engine/reference/builder.html#entrypoint
